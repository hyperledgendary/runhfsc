#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const cliffy_1 = require("cliffy");
const fabric_1 = require("./fabric");
const yargs = require("yargs");
const chalk = require("chalk");
const util = require("util");
const path = require("path");
const fs_1 = require("fs");
const pjson = fs_1.readFileSync(path.resolve(__dirname, '..', 'package.json'), 'utf-8');
const version = JSON.parse(pjson).version;
const params = yargs
    .options({
    gateway: {
        type: 'string',
        description: 'Gateway profile file',
        requiresArg: true,
        required: 'true',
    },
    wallet: {
        type: 'string',
        description: 'wallet directory path',
        requiresArg: true,
        required: 'true',
    },
    user: {
        alias: 'u',
        description: 'User wallet label',
        requiresArg: true,
        default: '',
        require: false,
    },
})
    .help()
    .wrap(null)
    .alias('v', 'version')
    .version(`ibpccl v${version}`)
    .usage('$0 --file filename')
    .help()
    .strict()
    .epilog('For usage see https://github.com/hyperledendary/runhfsc')
    .describe('v', 'show version information').argv;
const fabrics = {};
const current = 'default';
let cli;
const log = ({ msg = '>', val = '', error = false }) => {
    if (error) {
        console.log(chalk.redBright(msg) + ' ' + val);
    }
    else {
        console.log(chalk.bold(msg) + ' ' + val);
    }
};
const getPrompt = () => {
    const fabric = fabrics[current];
    if (!fabric) {
        return '[] > ';
    }
    let user = fabric.getUser();
    user = chalk.yellow(user === '' ? '<user>' : `${user}`);
    let channel = fabric.getChannel();
    channel = chalk.yellow(channel === '' ? '<channel>' : channel);
    let contractId = fabric.getContractId();
    contractId = chalk.yellow(contractId === '' ? '<contractid>' : contractId);
    const connected = fabric.getConnected() ? chalk.green('#') : chalk.gray('-');
    return chalk `{blue [${current}]} ${user}@${channel}:${contractId} ${connected} $ `;
};
const actionWrapper = (params, options, func) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        yield func(params, options);
    }
    catch (e) {
        log({ val: e.message, error: true });
    }
    cli.setDelimiter(getPrompt());
});
const main = (walletPath, connectionFile, user) => __awaiter(void 0, void 0, void 0, function* () {
    fabrics[current] = yield fabric_1.default.newFabric('default', walletPath, connectionFile);
    if (user && user !== '') {
        fabrics[current].setUser(user);
    }
    cli = new cliffy_1.CLI().setDelimiter(getPrompt());
    cli.addCommand('info', {
        description: 'Summary of the current settings',
        options: [],
        aliases: ['i'],
        parameters: [],
        action: () => {
            if (fabrics[current]) {
                log({ val: fabrics[current].getInfo() });
            }
        },
    });
    cli.addCommand('quit', {
        description: 'Quit',
        options: [],
        aliases: ['q'],
        parameters: [],
        action: () => {
            Object.values(fabrics).forEach((f) => {
                f.destroy();
            });
            process.exit(0);
        },
    });
    cli.addCommand('user', {
        description: 'Set user',
        options: [],
        aliases: ['u'],
        parameters: [{ label: 'username', description: 'User name' }],
        action: (params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            fabrics[current].setUser(params.username);
            log({ msg: 'User set to', val: params.username });
            yield fabrics[current].establish();
            log({ msg: 'Connected to Fabric' });
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('channel', {
        description: 'Set channel',
        aliases: ['n'],
        options: [],
        parameters: [{ label: 'channel', description: 'Channel name' }],
        action: (params, _options) => {
            fabrics[current].setChannel(params.channel);
            log({ msg: 'Channel set to', val: params.channel });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('contract', {
        description: 'Set contract',
        aliases: ['c'],
        options: [],
        parameters: [{ label: 'contract', description: 'contract name' }],
        action: (params, _options) => {
            fabrics[current].setContractId(params.contract);
            log({ msg: 'Contract set to', val: params.contract });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('submit', {
        description: 'Submit transactions',
        aliases: ['s'],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            log({ msg: 'Submitted args', val: params.args });
            const args = params.args;
            const result = yield fabrics[current].submit(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('evaluate', {
        description: 'Evaluate transactions',
        aliases: ['e'],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            if (!params.args) {
                params.args = '[]';
            }
            log({ msg: 'Submitted args', val: params.args });
            const args = JSON.parse(params.args);
            const result = yield fabrics[current].evaluate(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('metadata', {
        description: 'Display the metadata for the current contract',
        aliases: ['m'],
        parameters: [],
        action: (_params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            return actionWrapper(_params, _options, () => __awaiter(void 0, void 0, void 0, function* () {
                const result = yield fabrics[current].evaluate('org.hyperledger.fabric:GetMetadata', []);
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
                cli.setDelimiter(getPrompt());
            }));
        }),
    });
    cli.show();
});
main(params.wallet, params.gateway, params.user);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUlBLG1DQUE2QjtBQUM3QixxQ0FBOEI7QUFDOUIsK0JBQWdDO0FBQ2hDLCtCQUErQjtBQUMvQiw2QkFBNkI7QUFDN0IsNkJBQTZCO0FBQzdCLDJCQUFrQztBQUVsQyxNQUFNLEtBQUssR0FBRyxpQkFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxjQUFjLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNuRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUUxQyxNQUFNLE1BQU0sR0FBRyxLQUFLO0tBQ2YsT0FBTyxDQUFDO0lBQ0wsT0FBTyxFQUFFO1FBQ0wsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsc0JBQXNCO1FBQ25DLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFFBQVEsRUFBRSxNQUFNO0tBQ25CO0lBQ0QsTUFBTSxFQUFFO1FBQ0osSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsdUJBQXVCO1FBQ3BDLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFFBQVEsRUFBRSxNQUFNO0tBQ25CO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsS0FBSyxFQUFFLEdBQUc7UUFDVixXQUFXLEVBQUUsbUJBQW1CO1FBQ2hDLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLE9BQU8sRUFBRSxFQUFFO1FBQ1gsT0FBTyxFQUFFLEtBQUs7S0FDakI7Q0FDSixDQUFDO0tBQ0QsSUFBSSxFQUFFO0tBQ04sSUFBSSxDQUFDLElBQUksQ0FBQztLQUNWLEtBQUssQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDO0tBQ3JCLE9BQU8sQ0FBQyxXQUFXLE9BQU8sRUFBRSxDQUFDO0tBQzdCLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztLQUMzQixJ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QUFRLEVBQUUsRUFBRTtZQUNoQyxPQUFBLGFBQWEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQVMsRUFBRTtnQkFDeEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLG9DQUFvQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUV6RixHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUMvRCxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDbEMsQ0FBQyxDQUFBLENBQUMsQ0FBQTtVQUFBO0tBQ1QsQ0FBQyxDQUFDO0lBQ0gsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2YsQ0FBQyxDQUFBLENBQUM7QUFFRixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbi8qXG5TUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuKi9cbmltcG9ydCB7IENMSSB9IGZyb20gJ2NsaWZmeSc7XG5pbXBvcnQgRmFicmljIGZyb20gJy4vZmFicmljJztcbmltcG9ydCB5YXJncyA9IHJlcXVpcmUoJ3lhcmdzJyk7XG5pbXBvcnQgKiBhcyBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJ3V0aWwnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcblxuY29uc3QgcGpzb24gPSByZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3BhY2thZ2UuanNvbicpLCAndXRmLTgnKTtcbmNvbnN0IHZlcnNpb24gPSBKU09OLnBhcnNlKHBqc29uKS52ZXJzaW9uO1xuXG5jb25zdCBwYXJhbXMgPSB5YXJnc1xuICAgIC5vcHRpb25zKHtcbiAgICAgICAgZ2F0ZXdheToge1xuICAgICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0dhdGV3YXkgcHJvZmlsZSBmaWxlJyxcbiAgICAgICAgICAgIHJlcXVpcmVzQXJnOiB0cnVlLFxuICAgICAgICAgICAgcmVxdWlyZWQ6ICd0cnVlJyxcbiAgICAgICAgfSxcbiAgICAgICAgd2FsbGV0OiB7XG4gICAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnd2FsbGV0IGRpcmVjdG9yeSBwYXRoJyxcbiAgICAgICAgICAgIHJlcXVpcmVzQXJnOiB0cnVlLFxuICAgICAgICAgICAgcmVxdWlyZWQ6ICd0cnVlJyxcbiAgICAgICAgfSxcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgYWxpYXM6ICd1JyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVXNlciB3YWxsZXQgbGFiZWwnLFxuICAgICAgICAgICAgcmVxdWlyZXNBcmc6IHRydWUsXG4gICAgICAgICAgICBkZWZhdWx0OiAnJyxcbiAgICAgICAgICAgIHJlcXVpcmU6IGZhbHNlLFxuICAgICAgICB9LFxuICAgIH0pXG4gICAgLmhlbHAoKVxuICAgIC53cmFwKG51bGwpXG4gICAgLmFsaWFzKCd2JywgJ3ZlcnNpb24nKVxuICAgIC52ZXJzaW9uKGBpYnBjY2wgdiR7dmVyc2lvbn1gKVxuICAgIC51c2FnZSgnJDAgLS1maWxlIGZpbGVuYW1lJylcbiAgICAuaGVscCgpXG4gICAgLnN0cmljdCgpXG4gICAgLmVwaWxvZygnRm9yIHVzYWdlIHNlZSBodHRwczovL2dpdGh1Yi5jb20vaHlwZXJsZWRlbmRhcnkvcnVuaGZzYycpXG4gICAgLmRlc2NyaWJlKCd2JywgJ3Nob3cgdmVyc2lvbiBpbmZvcm1hdGlvbicpLmFyZ3Y7XG5cbmludGVyZmFjZSBGYWJyaWNJbnN0YW5jZSB7XG4gICAgW2tleTogc3RyaW5nXTogRmFicmljO1xufVxuXG5jb25zdCBmYWJyaWNzOiBGYWJyaWNJbnN0YW5jZSA9IHt9O1xuY29uc3QgY3VycmVudCA9ICdkZWZhdWx0JztcblxubGV0IGNsaTogQ0xJO1xuXG5jb25zdCBsb2cgPSAoeyBtc2cgPSAnPicsIHZhbCA9ICcnLCBlcnJvciA9IGZhbHNlIH06IHsgbXNnPzogc3RyaW5nOyB2YWw/OiBzdHJpbmc7IGVycm9yPzogYm9vbGVhbiB9KTogdm9pZCA9PiB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnJlZEJyaWdodChtc2cpICsgJyAnICsgdmFsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKG1zZykgKyAnICcgKyB2YWwpO1xuICAgIH1cbn07XG5cbmNvbnN0IGdldFByb21wdCA9ICgpOiBzdHJpbmcgPT4ge1xuICAgIGNvbnN0IGZhYnJpYyA9IGZhYnJpY3NbY3VycmVudF07XG4gICAgaWYgKCFmYWJyaWMpIHtcbiAgICAgICAgcmV0dXJuICdbXSA+ICc7XG4gICAgfVxuICAgIGxldCB1c2VyID0gZmFicmljLmdldFVzZXIoKTtcbiAgICB1c2VyID0gY2hhbGsueWVsbG93KHVzZXIgPT09ICcnID8gJzx1c2VyPicgOiBgJHt1c2VyfWApO1xuXG4gICAgbGV0IGNoYW5uZWwgPSBmYWJyaWMuZ2V0Q2hhbm5lbCgpO1xuICAgIGNoYW5uZWwgPSBjaGFsay55ZWxsb3coY2hhbm5lbCA9PT0gJycgPyAnPGNoYW5uZWw+JyA6IGNoYW5uZWwpO1xuXG4gICAgbGV0IGNvbnRyYWN0SWQgPSBmYWJyaWMuZ2V0Q29udHJhY3RJZCgpO1xuICAgIGNvbnRyYWN0SWQgPSBjaGFsay55ZWxsb3coY29udHJhY3RJZCA9PT0gJycgPyAnPGNvbnRyYWN0aWQ+JyA6IGNvbnRyYWN0SWQpO1xuXG4gICAgY29uc3QgY29ubmVjdGVkID0gZmFicmljLmdldENvbm5lY3RlZCgpID8gY2hhbGsuZ3JlZW4oJyMnKSA6IGNoYWxrLmdyYXkoJy0nKTtcblxuICAgIHJldHVybiBjaGFsa2B7Ymx1ZSBbJHtjdXJyZW50fV19ICR7dXNlcn1AJHtjaGFubmVsfToke2NvbnRyYWN0SWR9ICR7Y29ubmVjdGVkfSAkIGA7XG59O1xuXG5jb25zdCBhY3Rpb25XcmFwcGVyID0gYXN5bmMgKHBhcmFtczogYW55LCBvcHRpb25zOiBhbnksIGZ1bmM6IGFueSk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZ1bmMocGFyYW1zLCBvcHRpb25zKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZyh7IHZhbDogZS5tZXNzYWdlLCBlcnJvcjogdHJ1ZSB9KTtcbiAgICB9XG4gICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG59O1xuXG5jb25zdCBtYWluID0gYXN5bmMgKHdhbGxldFBhdGg6IHN0cmluZywgY29ubmVjdGlvbkZpbGU6IHN0cmluZywgdXNlcjogc3RyaW5nKSA9PiB7XG4gICAgZmFicmljc1tjdXJyZW50XSA9IGF3YWl0IEZhYnJpYy5uZXdGYWJyaWMoJ2RlZmF1bHQnLCB3YWxsZXRQYXRoLCBjb25uZWN0aW9uRmlsZSk7XG4gICAgaWYgKHVzZXIgJiYgdXNlciAhPT0gJycpIHtcbiAgICAgICAgZmFicmljc1tjdXJyZW50XS5zZXRVc2VyKHVzZXIpO1xuICAgIH1cbiAgICBjbGkgPSBuZXcgQ0xJKCkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcblxuICAgIC8vIGNsaS5hZGRDb21tYW5kKCdmYWJyaWMnLCB7XG4gICAgLy8gICAgIGRlc2NyaXB0aW9uOiAnQWRkIG5ldyB3YWxsZXQgYW5kIGNvbm5lY3Rpb24gcHJvZmlsZScsXG4gICAgLy8gICAgIG9wdGlvbnM6IFtdLFxuICAgIC8vICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgLy8gICAgICAgICB7IGxhYmVsOiAnbmFtZScsIGRlc2NyaXB0aW9uOiAnbmFtZScgfSxcbiAgICAvLyAgICAgICAgIHsgbGFiZWw6ICdnYXRld2F5JywgZGVzY3JpcHRpb246ICdDb25uZWN0aW9uIFByb2ZpbGUnIH0sXG4gICAgLy8gICAgICAgICB7IGxhYmVsOiAnd2FsbGV0JywgZGVzY3JpcHRpb246ICdhcHBsaWNhdGlvbiB3YWxsZXQgJyB9LFxuICAgIC8vICAgICBdLFxuICAgIC8vICAgICBhY3Rpb246IGFzeW5jIChwYXJhbXMsIF9vcHRpb25zKSA9PiB7XG4gICAgLy8gICAgICAgICBmYWJyaWNzW3BhcmFtcy5uYW1lXSA9IGF3YWl0IEZhYnJpYy5uZXdGYWJyaWMocGFyYW1zLm5hbWUsIHBhcmFtcy53YWxsZXQsIHBhcmFtcy5wcm9maWxlKTtcbiAgICAvLyAgICAgICAgIGN1cnJlbnQgPSBwYXJhbXMubmFtZTtcbiAgICAvLyAgICAgICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xuICAgIC8vICAgICB9LFxuICAgIC8vIH0pO1xuXG4gICAgY2xpLmFkZENvbW1hbmQoJ2luZm8nLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnU3VtbWFyeSBvZiB0aGUgY3VycmVudCBzZXR0aW5ncycsXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBhbGlhc2VzOiBbJ2knXSxcbiAgICAgICAgcGFyYW1ldGVyczogW10sXG4gICAgICAgIGFjdGlvbjogKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZhYnJpY3NbY3VycmVudF0pIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IGZhYnJpY3NbY3VycmVudF0uZ2V0SW5mbygpIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgY2xpLmFkZENvbW1hbmQoJ3F1aXQnLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnUXVpdCcsXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBhbGlhc2VzOiBbJ3EnXSxcbiAgICAgICAgcGFyYW1ldGVyczogW10sXG4gICAgICAgIGFjdGlvbjogKCkgPT4ge1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhmYWJyaWNzKS5mb3JFYWNoKChmKSA9PiB7XG4gICAgICAgICAgICAgICAgZi5kZXN0cm95KCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCd1c2VyJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1NldCB1c2VyJyxcbiAgICAgICAgb3B0aW9uczogW10sXG4gICAgICAgIGFsaWFzZXM6IFsndSddLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbeyBsYWJlbDogJ3VzZXJuYW1lJywgZGVzY3JpcHRpb246ICdVc2VyIG5hbWUnIH1dLFxuICAgICAgICBhY3Rpb246IGFzeW5jIChwYXJhbXMsIF9vcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmYWJyaWNzW2N1cnJlbnRdLnNldFVzZXIocGFyYW1zLnVzZXJuYW1lKTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogJ1VzZXIgc2V0IHRvJywgdmFsOiBwYXJhbXMudXNlcm5hbWUgfSk7XG4gICAgICAgICAgICBhd2FpdCBmYWJyaWNzW2N1cnJlbnRdLmVzdGFibGlzaCgpO1xuICAgICAgICAgICAgbG9nKHsgbXNnOiAnQ29ubmVjdGVkIHRvIEZhYnJpYycgfSk7XG4gICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdjaGFubmVsJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1NldCBjaGFubmVsJyxcbiAgICAgICAgYWxpYXNlczogWyduJ10sXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbeyBsYWJlbDogJ2NoYW5uZWwnLCBkZXNjcmlwdGlvbjogJ0NoYW5uZWwgbmFtZScgfV0sXG4gICAgICAgIGFjdGlvbjogKHBhcmFtcywgX29wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGZhYnJpY3NbY3VycmVudF0uc2V0Q2hhbm5lbChwYXJhbXMuY2hhbm5lbCk7XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdDaGFubmVsIHNldCB0bycsIHZhbDogcGFyYW1zLmNoYW5uZWwgfSk7XG4gICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdjb250cmFjdCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgY29udHJhY3QnLFxuICAgICAgICBhbGlhc2VzOiBbJ2MnXSxcbiAgICAgICAgb3B0aW9uczogW10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFt7IGxhYmVsOiAnY29udHJhY3QnLCBkZXNjcmlwdGlvbjogJ2NvbnRyYWN0IG5hbWUnIH1dLFxuICAgICAgICBhY3Rpb246IChwYXJhbXMsIF9vcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmYWJyaWNzW2N1cnJlbnRdLnNldENvbnRyYWN0SWQocGFyYW1zLmNvbnRyYWN0KTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogJ0NvbnRyYWN0IHNldCB0bycsIHZhbDogcGFyYW1zLmNvbnRyYWN0IH0pO1xuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgnc3VibWl0Jywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1N1Ym1pdCB0cmFuc2FjdGlvbnMnLFxuICAgICAgICBhbGlhc2VzOiBbJ3MnXSxcbiAgICAgICAgb3B0aW9uczogW3sgbGFiZWw6ICdqc29uJywgZGVzY3JpcHRpb246ICdGb3JtYXQgb3V0cHV0IGRhdGEgYXMgSlNPTicgfV0sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtcbiAgICAgICAgICAgIHsgbGFiZWw6ICd0eG5hbWUnLCBkZXNjcmlwdGlvbjogJ1RyYW5zYWN0aW9uIG5hbWUnIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdhcmdzJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0pTT04gZm9ybWF0IHN0cmluZyAnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsYWJlbDogJ3ByaXZhdGUnLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUHJpdmF0ZSBkYXRhIG1hcCcsXG4gICAgICAgICAgICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBhY3Rpb246IGFzeW5jIChwYXJhbXMsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGlmICghcGFyYW1zLmFyZ3MpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMuYXJncyA9ICdbXSc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdTdWJtaXR0ZWQgYXJncycsIHZhbDogcGFyYW1zLmFyZ3MgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBwYXJhbXMuYXJncztcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmFicmljc1tjdXJyZW50XS5zdWJtaXQocGFyYW1zLnR4bmFtZSwgYXJncyk7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5qc29uKSB7XG4gICAgICAgICAgICAgICAgbG9nKHsgdmFsOiB1dGlsLmluc3BlY3QoSlNPTi5wYXJzZShyZXN1bHQpLCBmYWxzZSwgNiwgdHJ1ZSkgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZyh7IHZhbDogcmVzdWx0IH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgfSxcbiAgICB9KTtcbiAgICBjbGkuYWRkQ29tbWFuZCgnZXZhbHVhdGUnLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRXZhbHVhdGUgdHJhbnNhY3Rpb25zJyxcbiAgICAgICAgYWxpYXNlczogWydlJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtcbiAgICAgICAgICAgIHsgbGFiZWw6ICd0eG5hbWUnLCBkZXNjcmlwdGlvbjogJ1RyYW5zYWN0aW9uIG5hbWUnIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdhcmdzJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0pTT04gZm9ybWF0IHN0cmluZyAnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsYWJlbDogJ3ByaXZhdGUnLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnUHJpdmF0ZSBkYXRhIG1hcCcsXG4gICAgICAgICAgICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBvcHRpb25zOiBbeyBsYWJlbDogJ2pzb24nLCBkZXNjcmlwdGlvbjogJ0Zvcm1hdCBvdXRwdXQgZGF0YSBhcyBKU09OJyB9XSxcbiAgICAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtcy5hcmdzKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zLmFyZ3MgPSAnW10nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFwYXJhbXMuYXJncykge1xuICAgICAgICAgICAgICAgIHBhcmFtcy5hcmdzID0gJ1tdJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxvZyh7IG1zZzogJ1N1Ym1pdHRlZCBhcmdzJywgdmFsOiBwYXJhbXMuYXJncyB9KTtcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBKU09OLnBhcnNlKHBhcmFtcy5hcmdzKTtcblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmFicmljc1tjdXJyZW50XS5ldmFsdWF0ZShwYXJhbXMudHhuYW1lLCBhcmdzKTtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmpzb24pIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHV0aWwuaW5zcGVjdChKU09OLnBhcnNlKHJlc3VsdCksIGZhbHNlLCA2LCB0cnVlKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbG9nKHsgdmFsOiByZXN1bHQgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgfSxcbiAgICB9KTtcbiAgICBjbGkuYWRkQ29tbWFuZCgnbWV0YWRhdGEnLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRGlzcGxheSB0aGUgbWV0YWRhdGEgZm9yIHRoZSBjdXJyZW50IGNvbnRyYWN0JyxcbiAgICAgICAgYWxpYXNlczogWydtJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBhY3Rpb246IGFzeW5jIChfcGFyYW1zLCBfb3B0aW9ucykgPT5cbiAgICAgICAgICAgIGFjdGlvbldyYXBwZXIoX3BhcmFtcywgX29wdGlvbnMsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmYWJyaWNzW2N1cnJlbnRdLmV2YWx1YXRlKCdvcmcuaHlwZXJsZWRnZXIuZmFicmljOkdldE1ldGFkYXRhJywgW10pO1xuXG4gICAgICAgICAgICAgICAgbG9nKHsgdmFsOiB1dGlsLmluc3BlY3QoSlNPTi5wYXJzZShyZXN1bHQpLCBmYWxzZSwgNiwgdHJ1ZSkgfSk7XG4gICAgICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgICAgICB9KSxcbiAgICB9KTtcbiAgICBjbGkuc2hvdygpO1xufTtcblxubWFpbihwYXJhbXMud2FsbGV0LCBwYXJhbXMuZ2F0ZXdheSwgcGFyYW1zLnVzZXIpO1xuIl19