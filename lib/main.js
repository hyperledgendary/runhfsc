#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const sourceMapSupport = require("source-map-support");
sourceMapSupport.install();
const cliffy_1 = require("cliffy");
const fabric_1 = require("./fabric");
const chalk = require("chalk");
const util = require("util");
const env = require("env-var");
const wallet = env.get('WALLETPATH').required().asString();
const gateway = env.get('GATEWAYPATH').required().asString();
const user = env.get('USER').required().asString();
const fabrics = {};
const current = 'default';
let cli;
const log = ({ msg = '>', val = '', error = false }) => {
    if (error) {
        console.log(chalk.redBright(msg) + ' ' + val);
    }
    else {
        console.log(chalk.bold(msg) + ' ' + val);
    }
};
const getPrompt = () => {
    const fabric = fabrics[current];
    if (!fabric) {
        return '[] > ';
    }
    let user = fabric.getUser();
    user = chalk.yellow(user === '' ? '<user>' : `${user}`);
    let channel = fabric.getChannel();
    channel = chalk.yellow(channel === '' ? '<channel>' : channel);
    let contractId = fabric.getContractId();
    contractId = chalk.yellow(contractId === '' ? '<contractid>' : contractId);
    const connected = fabric.getConnected() ? chalk.green('#') : chalk.gray('-');
    return chalk `{blue [${current}]} ${user}@${channel}:${contractId} ${connected} $ `;
};
const actionWrapper = (params, options, func) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        yield func(params, options);
    }
    catch (e) {
        log({ val: e.message, error: true });
    }
    cli.setDelimiter(getPrompt());
});
const main = (walletPath, connectionFile, user) => __awaiter(void 0, void 0, void 0, function* () {
    fabrics[current] = yield fabric_1.default.newFabric('default', walletPath, connectionFile);
    if (user && user !== '') {
        fabrics[current].setUser(user);
    }
    cli = new cliffy_1.CLI().setDelimiter(getPrompt());
    cli.addCommand('info', {
        description: 'Summary of the current settings',
        options: [],
        aliases: ['i'],
        parameters: [],
        action: () => {
            if (fabrics[current]) {
                log({ val: fabrics[current].getInfo() });
            }
        },
    });
    cli.addCommand('quit', {
        description: 'Quit',
        options: [],
        aliases: ['q'],
        parameters: [],
        action: () => {
            Object.values(fabrics).forEach((f) => {
                f.destroy();
            });
            process.exit(0);
        },
    });
    cli.addCommand('user', {
        description: 'Set user',
        options: [],
        aliases: ['u'],
        parameters: [{ label: 'username', description: 'User name' }],
        action: (params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            fabrics[current].setUser(params.username);
            log({ msg: 'User set to', val: params.username });
            yield fabrics[current].establish();
            log({ msg: 'Connected to Fabric' });
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('channel', {
        description: 'Set channel',
        aliases: ['n'],
        options: [],
        parameters: [{ label: 'channel', description: 'Channel name' }],
        action: (params, _options) => {
            fabrics[current].setChannel(params.channel);
            log({ msg: 'Channel set to', val: params.channel });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('contract', {
        description: 'Set contract',
        aliases: ['c'],
        options: [],
        parameters: [{ label: 'contract', description: 'contract name' }],
        action: (params, _options) => {
            fabrics[current].setContractId(params.contract);
            log({ msg: 'Contract set to', val: params.contract });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('submit', {
        description: 'Submit transactions',
        aliases: ['s'],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
                optional: true,
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            const args = JSON.parse(params.args);
            log({ msg: `Submitted ${params.txname} `, val: args.join(',') });
            const result = yield fabrics[current].submit(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('evaluate', {
        description: 'Evaluate transactions',
        aliases: ['e'],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
                optional: true,
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            const args = JSON.parse(params.args);
            log({ msg: `Submitted ${params.txname} `, val: args.join(',') });
            const result = yield fabrics[current].evaluate(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('metadata', {
        description: 'Display the metadata for the current contract',
        aliases: ['m'],
        parameters: [],
        action: (_params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            return actionWrapper(_params, _options, () => __awaiter(void 0, void 0, void 0, function* () {
                const result = yield fabrics[current].evaluate('org.hyperledger.fabric:GetMetadata', []);
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
                cli.setDelimiter(getPrompt());
            }));
        }),
    });
    cli.show();
});
main(wallet, gateway, user).catch((e) => {
    console.log(e);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUtBLHVEQUF1RDtBQUN2RCxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUUzQixtQ0FBNkI7QUFDN0IscUNBQThCO0FBRTlCLCtCQUErQjtBQUMvQiw2QkFBNkI7QUFJN0IsK0JBQStCO0FBSy9CLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDM0QsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUM3RCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBc0NuRCxNQUFNLE9BQU8sR0FBbUIsRUFBRSxDQUFDO0FBQ25DLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQztBQUUxQixJQUFJLEdBQVEsQ0FBQztBQUViLE1BQU0sR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRyxFQUFFLEdBQUcsR0FBRyxFQUFFLEVBQUUsS0FBSyxHQUFHLEtBQUssRUFBbUQsRUFBUSxFQUFFO0lBQzFHLElBQUksS0FBSyxFQUFFO1FBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztLQUNqRDtTQUFNO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztLQUM1QztBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sU0FB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SSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7SUFDekMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG4vKlxuU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiovXG5cbmltcG9ydCAqIGFzIHNvdXJjZU1hcFN1cHBvcnQgZnJvbSAnc291cmNlLW1hcC1zdXBwb3J0JztcbnNvdXJjZU1hcFN1cHBvcnQuaW5zdGFsbCgpO1xuXG5pbXBvcnQgeyBDTEkgfSBmcm9tICdjbGlmZnknO1xuaW1wb3J0IEZhYnJpYyBmcm9tICcuL2ZhYnJpYyc7XG4vLyBpbXBvcnQgeWFyZ3MgPSByZXF1aXJlKCd5YXJncycpO1xuaW1wb3J0ICogYXMgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJztcbi8vIGltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG4vLyBpbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5cbmltcG9ydCAqIGFzIGVudiBmcm9tICdlbnYtdmFyJztcblxuLy8gY29uc3QgcGpzb24gPSByZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3BhY2thZ2UuanNvbicpLCAndXRmLTgnKTtcbi8vIGNvbnN0IHZlcnNpb24gPSBKU09OLnBhcnNlKHBqc29uKS52ZXJzaW9uO1xuXG5jb25zdCB3YWxsZXQgPSBlbnYuZ2V0KCdXQUxMRVRQQVRIJykucmVxdWlyZWQoKS5hc1N0cmluZygpO1xuY29uc3QgZ2F0ZXdheSA9IGVudi5nZXQoJ0dBVEVXQVlQQVRIJykucmVxdWlyZWQoKS5hc1N0cmluZygpO1xuY29uc3QgdXNlciA9IGVudi5nZXQoJ1VTRVInKS5yZXF1aXJlZCgpLmFzU3RyaW5nKCk7XG5cbi8vIGNvbnN0IG9wdHM6IGFueSA9IHlhcmdzXG4vLyAgICAgLm9wdGlvbnMoe1xuLy8gICAgICAgICBnYXRld2F5OiB7XG4vLyAgICAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbi8vICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnR2F0ZXdheSBwcm9maWxlIGZpbGUnLFxuLy8gICAgICAgICAgICAgcmVxdWlyZXNBcmc6IHRydWUsXG4vLyAgICAgICAgICAgICByZXF1aXJlZDogJ3RydWUnLFxuLy8gICAgICAgICB9LFxuLy8gICAgICAgICB3YWxsZXQ6IHtcbi8vICAgICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuLy8gICAgICAgICAgICAgZGVzY3JpcHRpb246ICd3YWxsZXQgZGlyZWN0b3J5IHBhdGgnLFxuLy8gICAgICAgICAgICAgcmVxdWlyZXNBcmc6IHRydWUsXG4vLyAgICAgICAgICAgICByZXF1aXJlZDogJ3RydWUnLFxuLy8gICAgICAgICB9LFxuLy8gICAgICAgICB1c2VyOiB7XG4vLyAgICAgICAgICAgICBhbGlhczogJ3UnLFxuLy8gICAgICAgICAgICAgZGVzY3JpcHRpb246ICdVc2VyIHdhbGxldCBsYWJlbCcsXG4vLyAgICAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbi8vICAgICAgICAgICAgIGRlZmF1bHQ6ICcnLFxuLy8gICAgICAgICAgICAgcmVxdWlyZTogZmFsc2UsXG4vLyAgICAgICAgIH0sXG4vLyAgICAgfSlcbi8vICAgICAuaGVscCgpXG4vLyAgICAgLndyYXAobnVsbClcbi8vICAgICAuYWxpYXMoJ3YnLCAndmVyc2lvbicpXG4vLyAgICAgLnZlcnNpb24oYGlicGNjbCB2JHt2ZXJzaW9ufWApXG4vLyAgICAgLnVzYWdlKCckMCAtLWZpbGUgZmlsZW5hbWUnKVxuLy8gICAgIC5oZWxwKClcbi8vICAgICAuc3RyaWN0KClcbi8vICAgICAuZXBpbG9nKCdGb3IgdXNhZ2Ugc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9oeXBlcmxlZGVuZGFyeS9ydW5oZnNjJylcbi8vICAgICAuZGVzY3JpYmUoJ3YnLCAnc2hvdyB2ZXJzaW9uIGluZm9ybWF0aW9uJykuYXJndjtcblxuaW50ZXJmYWNlIEZhYnJpY0luc3RhbmNlIHtcbiAgICBba2V5OiBzdHJpbmddOiBGYWJyaWM7XG59XG5cbmNvbnN0IGZhYnJpY3M6IEZhYnJpY0luc3RhbmNlID0ge307XG5jb25zdCBjdXJyZW50ID0gJ2RlZmF1bHQnO1xuXG5sZXQgY2xpOiBDTEk7XG5cbmNvbnN0IGxvZyA9ICh7IG1zZyA9ICc+JywgdmFsID0gJycsIGVycm9yID0gZmFsc2UgfTogeyBtc2c/OiBzdHJpbmc7IHZhbD86IHN0cmluZzsgZXJyb3I/OiBib29sZWFuIH0pOiB2b2lkID0+IHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsucmVkQnJpZ2h0KG1zZykgKyAnICcgKyB2YWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQobXNnKSArICcgJyArIHZhbCk7XG4gICAgfVxufTtcblxuY29uc3QgZ2V0UHJvbXB0ID0gKCk6IHN0cmluZyA9PiB7XG4gICAgY29uc3QgZmFicmljID0gZmFicmljc1tjdXJyZW50XTtcbiAgICBpZiAoIWZhYnJpYykge1xuICAgICAgICByZXR1cm4gJ1tdID4gJztcbiAgICB9XG4gICAgbGV0IHVzZXIgPSBmYWJyaWMuZ2V0VXNlcigpO1xuICAgIHVzZXIgPSBjaGFsay55ZWxsb3codXNlciA9PT0gJycgPyAnPHVzZXI+JyA6IGAke3VzZXJ9YCk7XG5cbiAgICBsZXQgY2hhbm5lbCA9IGZhYnJpYy5nZXRDaGFubmVsKCk7XG4gICAgY2hhbm5lbCA9IGNoYWxrLnllbGxvdyhjaGFubmVsID09PSAnJyA/ICc8Y2hhbm5lbD4nIDogY2hhbm5lbCk7XG5cbiAgICBsZXQgY29udHJhY3RJZCA9IGZhYnJpYy5nZXRDb250cmFjdElkKCk7XG4gICAgY29udHJhY3RJZCA9IGNoYWxrLnllbGxvdyhjb250cmFjdElkID09PSAnJyA/ICc8Y29udHJhY3RpZD4nIDogY29udHJhY3RJZCk7XG5cbiAgICBjb25zdCBjb25uZWN0ZWQgPSBmYWJyaWMuZ2V0Q29ubmVjdGVkKCkgPyBjaGFsay5ncmVlbignIycpIDogY2hhbGsuZ3JheSgnLScpO1xuXG4gICAgcmV0dXJuIGNoYWxrYHtibHVlIFske2N1cnJlbnR9XX0gJHt1c2VyfUAke2NoYW5uZWx9OiR7Y29udHJhY3RJZH0gJHtjb25uZWN0ZWR9ICQgYDtcbn07XG5cbmNvbnN0IGFjdGlvbldyYXBwZXIgPSBhc3luYyAocGFyYW1zOiBhbnksIG9wdGlvbnM6IGFueSwgZnVuYzogYW55KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnVuYyhwYXJhbXMsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICBsb2coeyB2YWw6IGUubWVzc2FnZSwgZXJyb3I6IHRydWUgfSk7XG4gICAgfVxuICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xufTtcblxuY29uc3QgbWFpbiA9IGFzeW5jICh3YWxsZXRQYXRoOiBzdHJpbmcsIGNvbm5lY3Rpb25GaWxlOiBzdHJpbmcsIHVzZXI6IHN0cmluZykgPT4ge1xuICAgIGZhYnJpY3NbY3VycmVudF0gPSBhd2FpdCBGYWJyaWMubmV3RmFicmljKCdkZWZhdWx0Jywgd2FsbGV0UGF0aCwgY29ubmVjdGlvbkZpbGUpO1xuICAgIGlmICh1c2VyICYmIHVzZXIgIT09ICcnKSB7XG4gICAgICAgIGZhYnJpY3NbY3VycmVudF0uc2V0VXNlcih1c2VyKTtcbiAgICB9XG4gICAgY2xpID0gbmV3IENMSSgpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG5cbiAgICAvLyBjbGkuYWRkQ29tbWFuZCgnZmFicmljJywge1xuICAgIC8vICAgICBkZXNjcmlwdGlvbjogJ0FkZCBuZXcgd2FsbGV0IGFuZCBjb25uZWN0aW9uIHByb2ZpbGUnLFxuICAgIC8vICAgICBvcHRpb25zOiBbXSxcbiAgICAvLyAgICAgcGFyYW1ldGVyczogW1xuICAgIC8vICAgICAgICAgeyBsYWJlbDogJ25hbWUnLCBkZXNjcmlwdGlvbjogJ25hbWUnIH0sXG4gICAgLy8gICAgICAgICB7IGxhYmVsOiAnZ2F0ZXdheScsIGRlc2NyaXB0aW9uOiAnQ29ubmVjdGlvbiBQcm9maWxlJyB9LFxuICAgIC8vICAgICAgICAgeyBsYWJlbDogJ3dhbGxldCcsIGRlc2NyaXB0aW9uOiAnYXBwbGljYXRpb24gd2FsbGV0ICcgfSxcbiAgICAvLyAgICAgXSxcbiAgICAvLyAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgIC8vICAgICAgICAgZmFicmljc1twYXJhbXMubmFtZV0gPSBhd2FpdCBGYWJyaWMubmV3RmFicmljKHBhcmFtcy5uYW1lLCBwYXJhbXMud2FsbGV0LCBwYXJhbXMucHJvZmlsZSk7XG4gICAgLy8gICAgICAgICBjdXJyZW50ID0gcGFyYW1zLm5hbWU7XG4gICAgLy8gICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAvLyAgICAgfSxcbiAgICAvLyB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdpbmZvJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1N1bW1hcnkgb2YgdGhlIGN1cnJlbnQgc2V0dGluZ3MnLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgYWxpYXNlczogWydpJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIGlmIChmYWJyaWNzW2N1cnJlbnRdKSB7XG4gICAgICAgICAgICAgICAgbG9nKHsgdmFsOiBmYWJyaWNzW2N1cnJlbnRdLmdldEluZm8oKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdxdWl0Jywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1F1aXQnLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgYWxpYXNlczogWydxJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoZmFicmljcykuZm9yRWFjaCgoZikgPT4ge1xuICAgICAgICAgICAgICAgIGYuZGVzdHJveSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgndXNlcicsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgdXNlcicsXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBhbGlhc2VzOiBbJ3UnXSxcbiAgICAgICAgcGFyYW1ldGVyczogW3sgbGFiZWw6ICd1c2VybmFtZScsIGRlc2NyaXB0aW9uOiAnVXNlciBuYW1lJyB9XSxcbiAgICAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgZmFicmljc1tjdXJyZW50XS5zZXRVc2VyKHBhcmFtcy51c2VybmFtZSk7XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdVc2VyIHNldCB0bycsIHZhbDogcGFyYW1zLnVzZXJuYW1lIH0pO1xuICAgICAgICAgICAgYXdhaXQgZmFicmljc1tjdXJyZW50XS5lc3RhYmxpc2goKTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogJ0Nvbm5lY3RlZCB0byBGYWJyaWMnIH0pO1xuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgnY2hhbm5lbCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgY2hhbm5lbCcsXG4gICAgICAgIGFsaWFzZXM6IFsnbiddLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgcGFyYW1ldGVyczogW3sgbGFiZWw6ICdjaGFubmVsJywgZGVzY3JpcHRpb246ICdDaGFubmVsIG5hbWUnIH1dLFxuICAgICAgICBhY3Rpb246IChwYXJhbXMsIF9vcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmYWJyaWNzW2N1cnJlbnRdLnNldENoYW5uZWwocGFyYW1zLmNoYW5uZWwpO1xuICAgICAgICAgICAgbG9nKHsgbXNnOiAnQ2hhbm5lbCBzZXQgdG8nLCB2YWw6IHBhcmFtcy5jaGFubmVsIH0pO1xuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgnY29udHJhY3QnLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnU2V0IGNvbnRyYWN0JyxcbiAgICAgICAgYWxpYXNlczogWydjJ10sXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbeyBsYWJlbDogJ2NvbnRyYWN0JywgZGVzY3JpcHRpb246ICdjb250cmFjdCBuYW1lJyB9XSxcbiAgICAgICAgYWN0aW9uOiAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgZmFicmljc1tjdXJyZW50XS5zZXRDb250cmFjdElkKHBhcmFtcy5jb250cmFjdCk7XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdDb250cmFjdCBzZXQgdG8nLCB2YWw6IHBhcmFtcy5jb250cmFjdCB9KTtcbiAgICAgICAgICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgY2xpLmFkZENvbW1hbmQoJ3N1Ym1pdCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTdWJtaXQgdHJhbnNhY3Rpb25zJyxcbiAgICAgICAgYWxpYXNlczogWydzJ10sXG4gICAgICAgIG9wdGlvbnM6IFt7IGxhYmVsOiAnanNvbicsIGRlc2NyaXB0aW9uOiAnRm9ybWF0IG91dHB1dCBkYXRhIGFzIEpTT04nIH1dLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgICB7IGxhYmVsOiAndHhuYW1lJywgZGVzY3JpcHRpb246ICdUcmFuc2FjdGlvbiBuYW1lJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnYXJncycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdKU09OIGZvcm1hdCBzdHJpbmcgJyxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdwcml2YXRlJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1ByaXZhdGUgZGF0YSBtYXAnLFxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtcy5hcmdzKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zLmFyZ3MgPSAnW10nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgYXJnczogc3RyaW5nW10gPSBKU09OLnBhcnNlKHBhcmFtcy5hcmdzKTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogYFN1Ym1pdHRlZCAke3BhcmFtcy50eG5hbWV9IGAsIHZhbDogYXJncy5qb2luKCcsJykgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZhYnJpY3NbY3VycmVudF0uc3VibWl0KHBhcmFtcy50eG5hbWUsIGFyZ3MpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgICAgICAgICAgICAgIGxvZyh7IHZhbDogdXRpbC5pbnNwZWN0KEpTT04ucGFyc2UocmVzdWx0KSwgZmFsc2UsIDYsIHRydWUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHJlc3VsdCB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgY2xpLmFkZENvbW1hbmQoJ2V2YWx1YXRlJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ0V2YWx1YXRlIHRyYW5zYWN0aW9ucycsXG4gICAgICAgIGFsaWFzZXM6IFsnZSddLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgICB7IGxhYmVsOiAndHhuYW1lJywgZGVzY3JpcHRpb246ICdUcmFuc2FjdGlvbiBuYW1lJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnYXJncycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdKU09OIGZvcm1hdCBzdHJpbmcgJyxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdwcml2YXRlJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1ByaXZhdGUgZGF0YSBtYXAnLFxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgb3B0aW9uczogW3sgbGFiZWw6ICdqc29uJywgZGVzY3JpcHRpb246ICdGb3JtYXQgb3V0cHV0IGRhdGEgYXMgSlNPTicgfV0sXG4gICAgICAgIGFjdGlvbjogYXN5bmMgKHBhcmFtcywgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgaWYgKCFwYXJhbXMuYXJncykge1xuICAgICAgICAgICAgICAgIHBhcmFtcy5hcmdzID0gJ1tdJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGFyZ3M6IHN0cmluZ1tdID0gSlNPTi5wYXJzZShwYXJhbXMuYXJncyk7XG4gICAgICAgICAgICBsb2coeyBtc2c6IGBTdWJtaXR0ZWQgJHtwYXJhbXMudHhuYW1lfSBgLCB2YWw6IGFyZ3Muam9pbignLCcpIH0pO1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmYWJyaWNzW2N1cnJlbnRdLmV2YWx1YXRlKHBhcmFtcy50eG5hbWUsIGFyZ3MpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgICAgICAgICAgICAgIGxvZyh7IHZhbDogdXRpbC5pbnNwZWN0KEpTT04ucGFyc2UocmVzdWx0KSwgZmFsc2UsIDYsIHRydWUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHJlc3VsdCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xuICAgICAgICB9LFxuICAgIH0pO1xuICAgIGNsaS5hZGRDb21tYW5kKCdtZXRhZGF0YScsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdEaXNwbGF5IHRoZSBtZXRhZGF0YSBmb3IgdGhlIGN1cnJlbnQgY29udHJhY3QnLFxuICAgICAgICBhbGlhc2VzOiBbJ20nXSxcbiAgICAgICAgcGFyYW1ldGVyczogW10sXG4gICAgICAgIGFjdGlvbjogYXN5bmMgKF9wYXJhbXMsIF9vcHRpb25zKSA9PlxuICAgICAgICAgICAgYWN0aW9uV3JhcHBlcihfcGFyYW1zLCBfb3B0aW9ucywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZhYnJpY3NbY3VycmVudF0uZXZhbHVhdGUoJ29yZy5oeXBlcmxlZGdlci5mYWJyaWM6R2V0TWV0YWRhdGEnLCBbXSk7XG5cbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHV0aWwuaW5zcGVjdChKU09OLnBhcnNlKHJlc3VsdCksIGZhbHNlLCA2LCB0cnVlKSB9KTtcbiAgICAgICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgICAgIH0pLFxuICAgIH0pO1xuICAgIGNsaS5zaG93KCk7XG59O1xuXG5tYWluKHdhbGxldCwgZ2F0ZXdheSwgdXNlcikuY2F0Y2goKGU6IGFueSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGUpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbn0pO1xuIl19