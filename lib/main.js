#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const cliffy_1 = require("cliffy");
const fabric_1 = require("./fabric");
const yargs = require("yargs");
const chalk = require("chalk");
const util = require("util");
const path = require("path");
const fs_1 = require("fs");
const pjson = fs_1.readFileSync(path.resolve(__dirname, '..', 'package.json'), 'utf-8');
const version = JSON.parse(pjson).version;
const params = yargs
    .options({
    gateway: {
        type: 'string',
        description: 'Gateway profile file',
        requiresArg: true,
        required: 'true',
    },
    wallet: {
        type: 'string',
        description: 'wallet directory path',
        requiresArg: true,
        required: 'true',
    },
    user: {
        alias: 'u',
        description: 'User wallet label',
        requiresArg: true,
        default: '',
        require: false,
    },
})
    .help()
    .wrap(null)
    .alias('v', 'version')
    .version(`ibpccl v${version}`)
    .usage('$0 --file filename')
    .help()
    .strict()
    .epilog('For usage see https://github.com/hyperledendary/runhfsc')
    .describe('v', 'show version information').argv;
const fabrics = {};
const current = 'default';
let cli;
const log = ({ msg = '>', val = '', error = false }) => {
    if (error) {
        console.log(chalk.redBright(msg) + ' ' + val);
    }
    else {
        console.log(chalk.bold(msg) + ' ' + val);
    }
};
const getPrompt = () => {
    const fabric = fabrics[current];
    if (!fabric) {
        return '[] > ';
    }
    let user = fabric.getUser();
    user = chalk.yellow(user === '' ? '<user>' : `${user}`);
    let channel = fabric.getChannel();
    channel = chalk.yellow(channel === '' ? '<channel>' : channel);
    let contractId = fabric.getContractId();
    contractId = chalk.yellow(contractId === '' ? '<contractid>' : contractId);
    const connected = fabric.getConnected() ? chalk.green('#') : chalk.gray('-');
    return chalk `{blue [${current}]} ${user}@${channel}:${contractId} ${connected} $ `;
};
const actionWrapper = (params, options, func) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        yield func(params, options);
    }
    catch (e) {
        log({ val: e.message, error: true });
    }
    cli.setDelimiter(getPrompt());
});
const main = (walletPath, connectionFile, user) => __awaiter(void 0, void 0, void 0, function* () {
    fabrics[current] = yield fabric_1.default.newFabric('default', walletPath, connectionFile);
    if (user && user !== '') {
        fabrics[current].setUser(user);
    }
    cli = new cliffy_1.CLI().setDelimiter(getPrompt());
    cli.addCommand('info', {
        description: 'Summary of the current settings',
        options: [],
        aliases: ['i'],
        parameters: [],
        action: () => {
            if (fabrics[current]) {
                log({ val: fabrics[current].getInfo() });
            }
        },
    });
    cli.addCommand('quit', {
        description: 'Quit',
        options: [],
        aliases: ['q'],
        parameters: [],
        action: () => {
            Object.values(fabrics).forEach((f) => {
                f.destroy();
            });
            process.exit(0);
        },
    });
    cli.addCommand('user', {
        description: 'Set user',
        options: [],
        aliases: ['u'],
        parameters: [{ label: 'username', description: 'User name' }],
        action: (params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            fabrics[current].setUser(params.username);
            log({ msg: 'User set to', val: params.username });
            yield fabrics[current].establish();
            log({ msg: 'Connected to Fabric' });
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('channel', {
        description: 'Set channel',
        aliases: ['n'],
        options: [],
        parameters: [{ label: 'channel', description: 'Channel name' }],
        action: (params, _options) => {
            fabrics[current].setChannel(params.channel);
            log({ msg: 'Channel set to', val: params.channel });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('contract', {
        description: 'Set contract',
        aliases: ['c'],
        options: [],
        parameters: [{ label: 'contract', description: 'contract name' }],
        action: (params, _options) => {
            fabrics[current].setContractId(params.contract);
            log({ msg: 'Contract set to', val: params.contract });
            cli.setDelimiter(getPrompt());
        },
    });
    cli.addCommand('submit', {
        description: 'Submit transactions',
        aliases: ['s'],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
                optional: true,
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            const args = JSON.parse(params.args);
            log({ msg: `Submitted ${params.txname} `, val: args.join(',') });
            const result = yield fabrics[current].submit(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('evaluate', {
        description: 'Evaluate transactions',
        aliases: ['e'],
        parameters: [
            { label: 'txname', description: 'Transaction name' },
            {
                label: 'args',
                description: 'JSON format string ',
                optional: true,
            },
            {
                label: 'private',
                description: 'Private data map',
                optional: true,
            },
        ],
        options: [{ label: 'json', description: 'Format output data as JSON' }],
        action: (params, options) => __awaiter(void 0, void 0, void 0, function* () {
            if (!params.args) {
                params.args = '[]';
            }
            const args = JSON.parse(params.args);
            log({ msg: `Submitted ${params.txname} `, val: args.join(',') });
            const result = yield fabrics[current].evaluate(params.txname, args);
            if (options.json) {
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
            }
            else {
                log({ val: result });
            }
            cli.setDelimiter(getPrompt());
        }),
    });
    cli.addCommand('metadata', {
        description: 'Display the metadata for the current contract',
        aliases: ['m'],
        parameters: [],
        action: (_params, _options) => __awaiter(void 0, void 0, void 0, function* () {
            return actionWrapper(_params, _options, () => __awaiter(void 0, void 0, void 0, function* () {
                const result = yield fabrics[current].evaluate('org.hyperledger.fabric:GetMetadata', []);
                log({ val: util.inspect(JSON.parse(result), false, 6, true) });
                cli.setDelimiter(getPrompt());
            }));
        }),
    });
    cli.show();
});
main(params.wallet, params.gateway, params.user);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUlBLG1DQUE2QjtBQUM3QixxQ0FBOEI7QUFDOUIsK0JBQWdDO0FBQ2hDLCtCQUErQjtBQUMvQiw2QkFBNkI7QUFDN0IsNkJBQTZCO0FBQzdCLDJCQUFrQztBQUVsQyxNQUFNLEtBQUssR0FBRyxpQkFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxjQUFjLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNuRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUUxQyxNQUFNLE1BQU0sR0FBRyxLQUFLO0tBQ2YsT0FBTyxDQUFDO0lBQ0wsT0FBTyxFQUFFO1FBQ0wsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsc0JBQXNCO1FBQ25DLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFFBQVEsRUFBRSxNQUFNO0tBQ25CO0lBQ0QsTUFBTSxFQUFFO1FBQ0osSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsdUJBQXVCO1FBQ3BDLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFFBQVEsRUFBRSxNQUFNO0tBQ25CO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsS0FBSyxFQUFFLEdBQUc7UUFDVixXQUFXLEVBQUUsbUJBQW1CO1FBQ2hDLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLE9BQU8sRUFBRSxFQUFFO1FBQ1gsT0FBTyxFQUFFLEtBQUs7S0FDakI7Q0FDSixDQUFDO0tBQ0QsSUFBSSxFQUFFO0tBQ04sSUFBSSxDQUFDLElBQUksQ0FBQztLQUNWLEtBQUssQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDO0tBQ3JCLE9BQU8sQ0FBQyxXQUFXLE9BQU8sRUFBRSxDQUFDO0tBQzdCLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztLQUMzQixJ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RyxDQUFDO1FBQ2QsVUFBVSxFQUFFLEVBQUU7UUFDZCxNQUFNLEVBQUUsQ0FBTyxPQUFPLEVBQUUsUUFBUSxFQUFFLEVBQUU7WUFDaEMsT0FBQSxhQUFhLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxHQUFTLEVBQUU7Z0JBQ3hDLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxvQ0FBb0MsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFFekYsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDL0QsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQ2xDLENBQUMsQ0FBQSxDQUFDLENBQUE7VUFBQTtLQUNULENBQUMsQ0FBQztJQUNILEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNmLENBQUMsQ0FBQSxDQUFDO0FBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG4vKlxuU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiovXG5pbXBvcnQgeyBDTEkgfSBmcm9tICdjbGlmZnknO1xuaW1wb3J0IEZhYnJpYyBmcm9tICcuL2ZhYnJpYyc7XG5pbXBvcnQgeWFyZ3MgPSByZXF1aXJlKCd5YXJncycpO1xuaW1wb3J0ICogYXMgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5cbmNvbnN0IHBqc29uID0gcmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICdwYWNrYWdlLmpzb24nKSwgJ3V0Zi04Jyk7XG5jb25zdCB2ZXJzaW9uID0gSlNPTi5wYXJzZShwanNvbikudmVyc2lvbjtcblxuY29uc3QgcGFyYW1zID0geWFyZ3NcbiAgICAub3B0aW9ucyh7XG4gICAgICAgIGdhdGV3YXk6IHtcbiAgICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdHYXRld2F5IHByb2ZpbGUgZmlsZScsXG4gICAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbiAgICAgICAgICAgIHJlcXVpcmVkOiAndHJ1ZScsXG4gICAgICAgIH0sXG4gICAgICAgIHdhbGxldDoge1xuICAgICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ3dhbGxldCBkaXJlY3RvcnkgcGF0aCcsXG4gICAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbiAgICAgICAgICAgIHJlcXVpcmVkOiAndHJ1ZScsXG4gICAgICAgIH0sXG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIGFsaWFzOiAndScsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1VzZXIgd2FsbGV0IGxhYmVsJyxcbiAgICAgICAgICAgIHJlcXVpcmVzQXJnOiB0cnVlLFxuICAgICAgICAgICAgZGVmYXVsdDogJycsXG4gICAgICAgICAgICByZXF1aXJlOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICB9KVxuICAgIC5oZWxwKClcbiAgICAud3JhcChudWxsKVxuICAgIC5hbGlhcygndicsICd2ZXJzaW9uJylcbiAgICAudmVyc2lvbihgaWJwY2NsIHYke3ZlcnNpb259YClcbiAgICAudXNhZ2UoJyQwIC0tZmlsZSBmaWxlbmFtZScpXG4gICAgLmhlbHAoKVxuICAgIC5zdHJpY3QoKVxuICAgIC5lcGlsb2coJ0ZvciB1c2FnZSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2h5cGVybGVkZW5kYXJ5L3J1bmhmc2MnKVxuICAgIC5kZXNjcmliZSgndicsICdzaG93IHZlcnNpb24gaW5mb3JtYXRpb24nKS5hcmd2O1xuXG5pbnRlcmZhY2UgRmFicmljSW5zdGFuY2Uge1xuICAgIFtrZXk6IHN0cmluZ106IEZhYnJpYztcbn1cblxuY29uc3QgZmFicmljczogRmFicmljSW5zdGFuY2UgPSB7fTtcbmNvbnN0IGN1cnJlbnQgPSAnZGVmYXVsdCc7XG5cbmxldCBjbGk6IENMSTtcblxuY29uc3QgbG9nID0gKHsgbXNnID0gJz4nLCB2YWwgPSAnJywgZXJyb3IgPSBmYWxzZSB9OiB7IG1zZz86IHN0cmluZzsgdmFsPzogc3RyaW5nOyBlcnJvcj86IGJvb2xlYW4gfSk6IHZvaWQgPT4ge1xuICAgIGlmIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5yZWRCcmlnaHQobXNnKSArICcgJyArIHZhbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuYm9sZChtc2cpICsgJyAnICsgdmFsKTtcbiAgICB9XG59O1xuXG5jb25zdCBnZXRQcm9tcHQgPSAoKTogc3RyaW5nID0+IHtcbiAgICBjb25zdCBmYWJyaWMgPSBmYWJyaWNzW2N1cnJlbnRdO1xuICAgIGlmICghZmFicmljKSB7XG4gICAgICAgIHJldHVybiAnW10gPiAnO1xuICAgIH1cbiAgICBsZXQgdXNlciA9IGZhYnJpYy5nZXRVc2VyKCk7XG4gICAgdXNlciA9IGNoYWxrLnllbGxvdyh1c2VyID09PSAnJyA/ICc8dXNlcj4nIDogYCR7dXNlcn1gKTtcblxuICAgIGxldCBjaGFubmVsID0gZmFicmljLmdldENoYW5uZWwoKTtcbiAgICBjaGFubmVsID0gY2hhbGsueWVsbG93KGNoYW5uZWwgPT09ICcnID8gJzxjaGFubmVsPicgOiBjaGFubmVsKTtcblxuICAgIGxldCBjb250cmFjdElkID0gZmFicmljLmdldENvbnRyYWN0SWQoKTtcbiAgICBjb250cmFjdElkID0gY2hhbGsueWVsbG93KGNvbnRyYWN0SWQgPT09ICcnID8gJzxjb250cmFjdGlkPicgOiBjb250cmFjdElkKTtcblxuICAgIGNvbnN0IGNvbm5lY3RlZCA9IGZhYnJpYy5nZXRDb25uZWN0ZWQoKSA/IGNoYWxrLmdyZWVuKCcjJykgOiBjaGFsay5ncmF5KCctJyk7XG5cbiAgICByZXR1cm4gY2hhbGtge2JsdWUgWyR7Y3VycmVudH1dfSAke3VzZXJ9QCR7Y2hhbm5lbH06JHtjb250cmFjdElkfSAke2Nvbm5lY3RlZH0gJCBgO1xufTtcblxuY29uc3QgYWN0aW9uV3JhcHBlciA9IGFzeW5jIChwYXJhbXM6IGFueSwgb3B0aW9uczogYW55LCBmdW5jOiBhbnkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCBmdW5jKHBhcmFtcywgb3B0aW9ucyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2coeyB2YWw6IGUubWVzc2FnZSwgZXJyb3I6IHRydWUgfSk7XG4gICAgfVxuICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xufTtcblxuY29uc3QgbWFpbiA9IGFzeW5jICh3YWxsZXRQYXRoOiBzdHJpbmcsIGNvbm5lY3Rpb25GaWxlOiBzdHJpbmcsIHVzZXI6IHN0cmluZykgPT4ge1xuICAgIGZhYnJpY3NbY3VycmVudF0gPSBhd2FpdCBGYWJyaWMubmV3RmFicmljKCdkZWZhdWx0Jywgd2FsbGV0UGF0aCwgY29ubmVjdGlvbkZpbGUpO1xuICAgIGlmICh1c2VyICYmIHVzZXIgIT09ICcnKSB7XG4gICAgICAgIGZhYnJpY3NbY3VycmVudF0uc2V0VXNlcih1c2VyKTtcbiAgICB9XG4gICAgY2xpID0gbmV3IENMSSgpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG5cbiAgICAvLyBjbGkuYWRkQ29tbWFuZCgnZmFicmljJywge1xuICAgIC8vICAgICBkZXNjcmlwdGlvbjogJ0FkZCBuZXcgd2FsbGV0IGFuZCBjb25uZWN0aW9uIHByb2ZpbGUnLFxuICAgIC8vICAgICBvcHRpb25zOiBbXSxcbiAgICAvLyAgICAgcGFyYW1ldGVyczogW1xuICAgIC8vICAgICAgICAgeyBsYWJlbDogJ25hbWUnLCBkZXNjcmlwdGlvbjogJ25hbWUnIH0sXG4gICAgLy8gICAgICAgICB7IGxhYmVsOiAnZ2F0ZXdheScsIGRlc2NyaXB0aW9uOiAnQ29ubmVjdGlvbiBQcm9maWxlJyB9LFxuICAgIC8vICAgICAgICAgeyBsYWJlbDogJ3dhbGxldCcsIGRlc2NyaXB0aW9uOiAnYXBwbGljYXRpb24gd2FsbGV0ICcgfSxcbiAgICAvLyAgICAgXSxcbiAgICAvLyAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgIC8vICAgICAgICAgZmFicmljc1twYXJhbXMubmFtZV0gPSBhd2FpdCBGYWJyaWMubmV3RmFicmljKHBhcmFtcy5uYW1lLCBwYXJhbXMud2FsbGV0LCBwYXJhbXMucHJvZmlsZSk7XG4gICAgLy8gICAgICAgICBjdXJyZW50ID0gcGFyYW1zLm5hbWU7XG4gICAgLy8gICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAvLyAgICAgfSxcbiAgICAvLyB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdpbmZvJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1N1bW1hcnkgb2YgdGhlIGN1cnJlbnQgc2V0dGluZ3MnLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgYWxpYXNlczogWydpJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIGlmIChmYWJyaWNzW2N1cnJlbnRdKSB7XG4gICAgICAgICAgICAgICAgbG9nKHsgdmFsOiBmYWJyaWNzW2N1cnJlbnRdLmdldEluZm8oKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNsaS5hZGRDb21tYW5kKCdxdWl0Jywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ1F1aXQnLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgYWxpYXNlczogWydxJ10sXG4gICAgICAgIHBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoZmFicmljcykuZm9yRWFjaCgoZikgPT4ge1xuICAgICAgICAgICAgICAgIGYuZGVzdHJveSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgndXNlcicsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgdXNlcicsXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBhbGlhc2VzOiBbJ3UnXSxcbiAgICAgICAgcGFyYW1ldGVyczogW3sgbGFiZWw6ICd1c2VybmFtZScsIGRlc2NyaXB0aW9uOiAnVXNlciBuYW1lJyB9XSxcbiAgICAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgZmFicmljc1tjdXJyZW50XS5zZXRVc2VyKHBhcmFtcy51c2VybmFtZSk7XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdVc2VyIHNldCB0bycsIHZhbDogcGFyYW1zLnVzZXJuYW1lIH0pO1xuICAgICAgICAgICAgYXdhaXQgZmFicmljc1tjdXJyZW50XS5lc3RhYmxpc2goKTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogJ0Nvbm5lY3RlZCB0byBGYWJyaWMnIH0pO1xuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgnY2hhbm5lbCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTZXQgY2hhbm5lbCcsXG4gICAgICAgIGFsaWFzZXM6IFsnbiddLFxuICAgICAgICBvcHRpb25zOiBbXSxcbiAgICAgICAgcGFyYW1ldGVyczogW3sgbGFiZWw6ICdjaGFubmVsJywgZGVzY3JpcHRpb246ICdDaGFubmVsIG5hbWUnIH1dLFxuICAgICAgICBhY3Rpb246IChwYXJhbXMsIF9vcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBmYWJyaWNzW2N1cnJlbnRdLnNldENoYW5uZWwocGFyYW1zLmNoYW5uZWwpO1xuICAgICAgICAgICAgbG9nKHsgbXNnOiAnQ2hhbm5lbCBzZXQgdG8nLCB2YWw6IHBhcmFtcy5jaGFubmVsIH0pO1xuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjbGkuYWRkQ29tbWFuZCgnY29udHJhY3QnLCB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnU2V0IGNvbnRyYWN0JyxcbiAgICAgICAgYWxpYXNlczogWydjJ10sXG4gICAgICAgIG9wdGlvbnM6IFtdLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbeyBsYWJlbDogJ2NvbnRyYWN0JywgZGVzY3JpcHRpb246ICdjb250cmFjdCBuYW1lJyB9XSxcbiAgICAgICAgYWN0aW9uOiAocGFyYW1zLCBfb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgZmFicmljc1tjdXJyZW50XS5zZXRDb250cmFjdElkKHBhcmFtcy5jb250cmFjdCk7XG4gICAgICAgICAgICBsb2coeyBtc2c6ICdDb250cmFjdCBzZXQgdG8nLCB2YWw6IHBhcmFtcy5jb250cmFjdCB9KTtcbiAgICAgICAgICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgY2xpLmFkZENvbW1hbmQoJ3N1Ym1pdCcsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdTdWJtaXQgdHJhbnNhY3Rpb25zJyxcbiAgICAgICAgYWxpYXNlczogWydzJ10sXG4gICAgICAgIG9wdGlvbnM6IFt7IGxhYmVsOiAnanNvbicsIGRlc2NyaXB0aW9uOiAnRm9ybWF0IG91dHB1dCBkYXRhIGFzIEpTT04nIH1dLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgICB7IGxhYmVsOiAndHhuYW1lJywgZGVzY3JpcHRpb246ICdUcmFuc2FjdGlvbiBuYW1lJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnYXJncycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdKU09OIGZvcm1hdCBzdHJpbmcgJyxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdwcml2YXRlJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1ByaXZhdGUgZGF0YSBtYXAnLFxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgYWN0aW9uOiBhc3luYyAocGFyYW1zLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtcy5hcmdzKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zLmFyZ3MgPSAnW10nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgYXJnczogc3RyaW5nW10gPSBKU09OLnBhcnNlKHBhcmFtcy5hcmdzKTtcbiAgICAgICAgICAgIGxvZyh7IG1zZzogYFN1Ym1pdHRlZCAke3BhcmFtcy50eG5hbWV9IGAsIHZhbDogYXJncy5qb2luKCcsJykgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZhYnJpY3NbY3VycmVudF0uc3VibWl0KHBhcmFtcy50eG5hbWUsIGFyZ3MpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgICAgICAgICAgICAgIGxvZyh7IHZhbDogdXRpbC5pbnNwZWN0KEpTT04ucGFyc2UocmVzdWx0KSwgZmFsc2UsIDYsIHRydWUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHJlc3VsdCB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2xpLnNldERlbGltaXRlcihnZXRQcm9tcHQoKSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgY2xpLmFkZENvbW1hbmQoJ2V2YWx1YXRlJywge1xuICAgICAgICBkZXNjcmlwdGlvbjogJ0V2YWx1YXRlIHRyYW5zYWN0aW9ucycsXG4gICAgICAgIGFsaWFzZXM6IFsnZSddLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgICB7IGxhYmVsOiAndHhuYW1lJywgZGVzY3JpcHRpb246ICdUcmFuc2FjdGlvbiBuYW1lJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxhYmVsOiAnYXJncycsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdKU09OIGZvcm1hdCBzdHJpbmcgJyxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWw6ICdwcml2YXRlJyxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1ByaXZhdGUgZGF0YSBtYXAnLFxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgb3B0aW9uczogW3sgbGFiZWw6ICdqc29uJywgZGVzY3JpcHRpb246ICdGb3JtYXQgb3V0cHV0IGRhdGEgYXMgSlNPTicgfV0sXG4gICAgICAgIGFjdGlvbjogYXN5bmMgKHBhcmFtcywgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgaWYgKCFwYXJhbXMuYXJncykge1xuICAgICAgICAgICAgICAgIHBhcmFtcy5hcmdzID0gJ1tdJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGFyZ3M6IHN0cmluZ1tdID0gSlNPTi5wYXJzZShwYXJhbXMuYXJncyk7XG4gICAgICAgICAgICBsb2coeyBtc2c6IGBTdWJtaXR0ZWQgJHtwYXJhbXMudHhuYW1lfSBgLCB2YWw6IGFyZ3Muam9pbignLCcpIH0pO1xuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmYWJyaWNzW2N1cnJlbnRdLmV2YWx1YXRlKHBhcmFtcy50eG5hbWUsIGFyZ3MpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgICAgICAgICAgICAgIGxvZyh7IHZhbDogdXRpbC5pbnNwZWN0KEpTT04ucGFyc2UocmVzdWx0KSwgZmFsc2UsIDYsIHRydWUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHJlc3VsdCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNsaS5zZXREZWxpbWl0ZXIoZ2V0UHJvbXB0KCkpO1xuICAgICAgICB9LFxuICAgIH0pO1xuICAgIGNsaS5hZGRDb21tYW5kKCdtZXRhZGF0YScsIHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdEaXNwbGF5IHRoZSBtZXRhZGF0YSBmb3IgdGhlIGN1cnJlbnQgY29udHJhY3QnLFxuICAgICAgICBhbGlhc2VzOiBbJ20nXSxcbiAgICAgICAgcGFyYW1ldGVyczogW10sXG4gICAgICAgIGFjdGlvbjogYXN5bmMgKF9wYXJhbXMsIF9vcHRpb25zKSA9PlxuICAgICAgICAgICAgYWN0aW9uV3JhcHBlcihfcGFyYW1zLCBfb3B0aW9ucywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZhYnJpY3NbY3VycmVudF0uZXZhbHVhdGUoJ29yZy5oeXBlcmxlZGdlci5mYWJyaWM6R2V0TWV0YWRhdGEnLCBbXSk7XG5cbiAgICAgICAgICAgICAgICBsb2coeyB2YWw6IHV0aWwuaW5zcGVjdChKU09OLnBhcnNlKHJlc3VsdCksIGZhbHNlLCA2LCB0cnVlKSB9KTtcbiAgICAgICAgICAgICAgICBjbGkuc2V0RGVsaW1pdGVyKGdldFByb21wdCgpKTtcbiAgICAgICAgICAgIH0pLFxuICAgIH0pO1xuICAgIGNsaS5zaG93KCk7XG59O1xuXG5tYWluKHBhcmFtcy53YWxsZXQsIHBhcmFtcy5nYXRld2F5LCBwYXJhbXMudXNlcik7XG4iXX0=